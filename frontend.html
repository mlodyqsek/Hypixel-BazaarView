<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypixel Bazaar</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif;
            background: #0d0d0d;
            color: #d1d4dc;
            overflow: hidden;
        }

        .top-nav {
            height: 48px;
            background: #161a1e;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 16px;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            color: #2962ff;
            letter-spacing: -0.5px;
        }

        .symbol-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-left: 16px;
            border-left: 1px solid #2a2e39;
        }

        .symbol-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .symbol-price {
            font-size: 18px;
            font-weight: 600;
            color: #26a69a;
        }

        .symbol-price.red {
            color: #ef5350;
        }

        .symbol-change {
            font-size: 14px;
            color: #26a69a;
        }

        .symbol-change.red {
            color: #ef5350;
        }

        .main-layout {
            display: flex;
            height: calc(100vh - 48px);
        }

        .symbol-sidebar {
            width: 260px;
            background: #161a1e;
            border-right: 1px solid #2a2e39;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid #2a2e39;
        }

        .sidebar-title {
            font-size: 13px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .search-box {
            width: 100%;
            padding: 8px 12px;
            background: #1e222d;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            color: #d1d4dc;
            font-size: 13px;
        }

        .search-box:focus {
            outline: none;
            border-color: #2962ff;
        }

        .symbol-list {
            flex: 1;
            overflow-y: auto;
        }

        .symbol-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #1e222d;
            transition: background 0.15s;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .symbol-item:hover {
            background: #1e222d;
        }

        .symbol-item.active {
            background: #2962ff15;
            border-left: 3px solid #2962ff;
            padding-left: 13px;
        }

        .symbol-name-text {
            flex: 1;
        }

        .symbol-change-percent {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .symbol-change-percent.positive {
            color: #089981;
            background: rgba(8, 153, 129, 0.1);
        }

        .symbol-change-percent.negative {
            color: #f23645;
            background: rgba(242, 54, 69, 0.1);
        }

        .chart-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0d0d0d;
        }

        .chart-toolbar {
            height: 48px;
            background: #161a1e;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 8px;
        }

        .toolbar-group {
            display: flex;
            gap: 4px;
            padding-right: 12px;
            border-right: 1px solid #2a2e39;
        }

        .toolbar-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: #787b86;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
        }

        .toolbar-btn:hover {
            background: #1e222d;
            color: #d1d4dc;
        }

        .toolbar-btn.active {
            background: #2962ff;
            color: #fff;
        }

        .chart-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 0;
        }

        .main-chart {
            flex: 1;
            position: relative;
            background: #0d0d0d;
            min-height: 0;
        }

        .price-info {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 10;
            background: rgba(13, 13, 13, 0.85);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 4px;
            display: flex;
            gap: 16px;
            font-size: 12px;
        }

        .price-stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .price-label {
            color: #787b86;
            font-size: 11px;
            font-weight: 500;
        }

        .price-value {
            color: #d1d4dc;
            font-weight: 600;
            font-size: 13px;
        }

        .price-value.green {
            color: #26a69a;
        }

        .price-value.red {
            color: #ef5350;
        }

        .volume-panel {
            height: 140px;
            background: #0d0d0d;
            border-top: 1px solid #2a2e39;
        }

        .orderbook-sidebar {
            width: 320px;
            background: #161a1e;
            border-left: 1px solid #2a2e39;
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #2a2e39;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }

        .sidebar-tab:hover {
            color: #d1d4dc;
            background: #1e222d;
        }

        .sidebar-tab.active {
            color: #2962ff;
            border-bottom-color: #2962ff;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .tab-content.active {
            display: block;
        }

        .custom-algo-section {
            margin-bottom: 16px;
        }

        .algo-editor {
            width: 100%;
            min-height: 200px;
            background: #1e222d;
            border: 1px solid #2a2e39;
            border-radius: 4px;
            padding: 12px;
            color: #d1d4dc;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .algo-editor:focus {
            outline: none;
            border-color: #2962ff;
        }

        .btn {
            padding: 8px 16px;
            background: #2962ff;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn:hover {
            background: #1e53e5;
        }

        .btn-secondary {
            background: #2a2e39;
            margin-left: 8px;
        }

        .btn-secondary:hover {
            background: #363a45;
        }

        .algo-help {
            background: #1e222d;
            padding: 12px;
            border-radius: 4px;
            font-size: 11px;
            color: #787b86;
            margin-top: 12px;
            line-height: 1.6;
        }

        .algo-help code {
            background: #0d0d0d;
            padding: 2px 6px;
            border-radius: 3px;
            color: #2962ff;
        }

        .error-message {
            background: rgba(242, 54, 69, 0.1);
            border: 1px solid #f23645;
            padding: 12px;
            border-radius: 4px;
            color: #f23645;
            font-size: 12px;
            margin-top: 12px;
        }

        .success-message {
            background: rgba(8, 153, 129, 0.1);
            border: 1px solid #089981;
            padding: 12px;
            border-radius: 4px;
            color: #089981;
            font-size: 12px;
            margin-top: 12px;
        }

        .orderbook-header {
            padding: 12px 16px;
            border-bottom: 1px solid #2a2e39;
        }

        .orderbook-title {
            font-size: 13px;
            font-weight: 600;
            color: #787b86;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .orderbook-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .orderbook-section {
            margin-bottom: 24px;
        }

        .orderbook-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #787b86;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            border-radius: 3px;
            margin-bottom: 2px;
        }

        .order-row.buy {
            background: rgba(8, 153, 129, 0.05);
        }

        .order-row.sell {
            background: rgba(242, 54, 69, 0.05);
        }

        .order-price {
            font-weight: 600;
        }

        .order-price.buy {
            color: #089981;
        }

        .order-price.sell {
            color: #f23645;
        }

        .order-amount {
            color: #787b86;
        }

        .stat-item {
            margin-bottom: 16px;
        }

        .stat-label {
            color: #787b86;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 15px;
            font-weight: 500;
            color: #d1d4dc;
        }

        .stat-value.positive {
            color: #089981;
        }

        .stat-value.negative {
            color: #f23645;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #161a1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #2a2e39;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #363a45;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #787b86;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="top-nav">
        <div class="logo">HYPIXEL BAZAAR</div>
        <div class="symbol-info">
            <div class="symbol-name" id="topSymbol">-</div>
            <div class="symbol-price" id="topPrice">-</div>
            <div class="symbol-change" id="topChange">-</div>
        </div>
    </div>

    <div class="main-layout">
        <div class="symbol-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Markets</div>
                <input type="text" class="search-box" placeholder="Search symbols..." id="searchInput">
            </div>
            <div class="symbol-list" id="symbolList">
                <div class="loading">Loading symbols...</div>
            </div>
        </div>

        <div class="chart-area">
            <div class="chart-toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-btn" data-interval="1">1m</button>
                    <button class="toolbar-btn active" data-interval="5">5m</button>
                    <button class="toolbar-btn" data-interval="15">15m</button>
                    <button class="toolbar-btn" data-interval="60">1h</button>
                </div>
                <div class="toolbar-group">
                    <select id="indicatorSelect" style="padding: 6px 12px; background: #1e222d; border: 1px solid #2a2e39; border-radius: 4px; color: #d1d4dc; font-size: 13px; cursor: pointer;">
                        <option value="none">No Indicator</option>
                        <option value="sma">SMA (Simple Moving Average)</option>
                        <option value="ema">EMA (Exponential Moving Average)</option>
                        <option value="bb">Bollinger Bands</option>
                    </select>
                </div>
            </div>

            <div class="chart-wrapper">
                <div class="main-chart" id="mainChart">
                    <div class="price-info" id="priceInfo"></div>
                </div>
                <div class="volume-panel" id="volumePanel"></div>
            </div>
        </div>

        <div class="orderbook-sidebar">
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="stats">Stats</button>
                <button class="sidebar-tab" data-tab="algo">Custom Algo</button>
            </div>
            
            <div class="tab-content active" id="statsTab">
                <div id="orderbookContent">
                    <div class="loading">Select a symbol</div>
                </div>
            </div>
            
            <div class="tab-content" id="algoTab">
                <div class="custom-algo-section">
                    <div style="color: #787b86; font-size: 11px; margin-bottom: 8px; font-weight: 600; text-transform: uppercase;">Custom Algorithm</div>
                    <textarea id="algoEditor" class="algo-editor" placeholder="Write your algorithm here...">// Example: Simple Moving Average
function customIndicator(data) {
  const period = 10;
  const result = [];
  
  for (let i = period - 1; i < data.length; i++) {
    const slice = data.slice(i - period + 1, i + 1);
    const sum = slice.reduce((a, b) => a + b.value, 0);
    result.push({
      time: data[i].time,
      value: sum / period
    });
  }
  
  return {
    data: result,
    color: '#00ff00',
    lineWidth: 2
  };
}</textarea>
                    
                    <div style="margin-top: 12px; display: flex;">
                        <button class="btn" onclick="runCustomAlgo()">Run Algorithm</button>
                        <button class="btn btn-secondary" onclick="clearCustomAlgo()">Clear</button>
                    </div>
                    
                    <div id="algoMessage"></div>
                    
                    <div class="algo-help">
                        <strong>How to use:</strong><br>
                        • Your function receives <code>data</code> array with <code>{time, value}</code> objects<br>
                        • Return an object with <code>data</code>, <code>color</code>, and <code>lineWidth</code><br>
                        • <code>data</code> must be array of <code>{time, value}</code><br>
                        • You can return multiple lines by using <code>lines</code> array instead<br><br>
                        
                        <strong>Example - RSI:</strong><br>
                        <code style="display: block; white-space: pre; margin-top: 8px;">function customIndicator(data) {
  // Your RSI calculation here
  return {
    data: rsiData,
    color: '#ff00ff',
    lineWidth: 2
  };
}</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chart, volumeChart, candleSeries, volumeSeries;
        let indicatorSeries = null;
        let upperBandSeries = null;
        let lowerBandSeries = null;
        let customAlgoSeries = [];
        let currentChartData = [];
        let currentSymbol = null;
        let currentInterval = 5;
        let allSymbols = [];
        let symbolPriceCache = {};
        let refreshTimer;

        function initCharts() {
            const chartContainer = document.getElementById('mainChart');
            const volumeContainer = document.getElementById('volumePanel');

            chart = LightweightCharts.createChart(chartContainer, {
                layout: {
                    background: { color: '#0d0d0d' },
                    textColor: '#787b86',
                },
                grid: {
                    vertLines: { color: '#1a1e23' },
                    horzLines: { color: '#1a1e23' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: {
                        color: '#758696',
                        width: 1,
                        style: 3,
                    },
                    horzLine: {
                        color: '#758696',
                        width: 1,
                        style: 3,
                    },
                },
                rightPriceScale: {
                    borderColor: '#2a2e39',
                    scaleMargins: {
                        top: 0.1,
                        bottom: 0.2,
                    },
                    autoScale: true,
                },
                timeScale: {
                    borderColor: '#2a2e39',
                    timeVisible: true,
                    secondsVisible: false,
                    rightOffset: 12,
                    barSpacing: 15,
                    minBarSpacing: 8,
                },
                handleScroll: {
                    mouseWheel: true,
                    pressedMouseMove: true,
                },
                handleScale: {
                    axisPressedMouseMove: true,
                    mouseWheel: true,
                    pinch: true,
                },
            });

            // Use an area chart to make price movements more visible
            candleSeries = chart.addAreaSeries({
                topColor: 'rgba(41, 98, 255, 0.4)',
                bottomColor: 'rgba(41, 98, 255, 0.0)',
                lineColor: 'rgba(41, 98, 255, 1)',
                lineWidth: 2,
                priceFormat: {
                    type: 'price',
                    precision: 2,
                    minMove: 0.01,
                },
            });

            volumeChart = LightweightCharts.createChart(volumeContainer, {
                layout: {
                    background: { color: '#0d0d0d' },
                    textColor: '#787b86',
                },
                grid: {
                    vertLines: { color: '#1a1e23' },
                    horzLines: { color: '#1a1e23' },
                },
                height: 140,
                rightPriceScale: {
                    borderColor: '#2a2e39',
                    scaleMargins: {
                        top: 0.1,
                        bottom: 0,
                    },
                },
                timeScale: {
                    borderColor: '#2a2e39',
                    visible: false,
                    rightOffset: 12,
                    barSpacing: 15,
                    minBarSpacing: 8,
                },
            });

            volumeSeries = volumeChart.addHistogramSeries({
                color: '#26a69a',
                priceFormat: {
                    type: 'volume',
                },
            });

            chart.timeScale().subscribeVisibleLogicalRangeChange(range => {
                volumeChart.timeScale().setVisibleLogicalRange(range);
            });

            const observer = new ResizeObserver(() => {
                chart.applyOptions({ 
                    width: chartContainer.clientWidth,
                    height: chartContainer.clientHeight 
                });
                volumeChart.applyOptions({ 
                    width: volumeContainer.clientWidth 
                });
            });
            observer.observe(chartContainer);
            observer.observe(volumeContainer);
        }

        async function loadSymbols() {
            try {
                const res = await fetch('/api/products');
                allSymbols = await res.json();
                
                console.log(`Successfully loaded ${allSymbols.length} trading symbols`);
                
                // Render symbols first
                renderSymbols(allSymbols);
                
                if (allSymbols.length > 0) {
                    selectSymbol(allSymbols[0]);
                }
                
                // Load price data for all symbols in background
                updateAllSymbolPrices();
                
            } catch (err) {
                console.error('Failed to load symbols', err);
                document.getElementById('symbolList').innerHTML = '<div class="loading">Failed to load symbols</div>';
            }
        }

        async function updateAllSymbolPrices() {
            for (const symbol of allSymbols) {
                try {
                    const res = await fetch(`/api/candles?product=${encodeURIComponent(symbol)}&hours=24`);
                    const data = await res.json();
                    if (data.candles && data.candles.length > 0) {
                        const first = data.candles[0];
                        const latest = data.candles[data.candles.length - 1];
                        const change = ((parseFloat(latest.close) - parseFloat(first.open)) / parseFloat(first.open)) * 100;
                        symbolPriceCache[symbol] = {
                            price: parseFloat(latest.close),
                            change: change
                        };
                    }
                } catch (err) {
                    // Skip symbols with no data
                }
            }
            // Re-render with price changes
            renderSymbols(allSymbols);
        }

        function renderSymbols(symbols) {
            const list = document.getElementById('symbolList');
            if (symbols.length === 0) {
                list.innerHTML = '<div class="loading">No symbols found</div>';
                return;
            }
            list.innerHTML = symbols.map(s => {
                const displayName = s.replace(/_/g, ' ');
                const cached = symbolPriceCache[s];
                let changeHtml = '';
                if (cached) {
                    const changeClass = cached.change >= 0 ? 'positive' : 'negative';
                    const changeSign = cached.change >= 0 ? '+' : '';
                    changeHtml = `<span class="symbol-change-percent ${changeClass}">${changeSign}${cached.change.toFixed(2)}%</span>`;
                }
                return `<div class="symbol-item" data-symbol="${s}" onclick="selectSymbol('${s}')">
                    <span class="symbol-name-text">${displayName}</span>
                    ${changeHtml}
                </div>`;
            }).join('');
        }

        function selectSymbol(symbol) {
            currentSymbol = symbol;
            const displayName = symbol.replace(/_/g, ' ');
            document.getElementById('topSymbol').textContent = displayName;
            
            document.querySelectorAll('.symbol-item').forEach(el => {
                el.classList.toggle('active', el.dataset.symbol === symbol);
            });
            
            loadChartData();
        }

        async function loadChartData() {
            if (!currentSymbol) return;

            const hours = currentInterval === 1 ? 1 : 
                         currentInterval === 5 ? 3 : 
                         currentInterval === 15 ? 8 : 24;

            try {
                const res = await fetch(`/api/candles?product=${encodeURIComponent(currentSymbol)}&hours=${hours}`);
                const data = await res.json();

                console.log(`Loaded ${data.candles ? data.candles.length : 0} candlestick data points`);

                if (!data.candles || data.candles.length === 0) {
                    console.log('No candle data available');
                    return;
                }

                // Use close prices for area chart
                const chartData = data.candles.map(c => ({
                    time: new Date(c.timestamp).getTime() / 1000,
                    value: parseFloat(c.close),
                }));

                const volumes = data.candles.map(c => {
                    const open = parseFloat(c.open);
                    const close = parseFloat(c.close);
                    return {
                        time: new Date(c.timestamp).getTime() / 1000,
                        value: parseInt(c.buy_volume) + parseInt(c.sell_volume),
                        color: close >= open ? '#26a69a80' : '#ef535080',
                    };
                });

                console.log(`Displaying ${chartData.length} data points on the chart`);

                candleSeries.setData(chartData);
                volumeSeries.setData(volumes);

                // Keep the data available for custom algorithms
                currentChartData = chartData;

                // Apply the currently selected technical indicator
                applyIndicator(chartData);

                setTimeout(() => {
                    chart.timeScale().fitContent();
                }, 100);

                updatePriceInfo(data.candles);
                updateTopBar(data.candles);
                await updateMarketStats(data.candles);

            } catch (err) {
                console.error('Failed to load data', err);
            }
        }

        function updatePriceInfo(candles) {
            if (!candles.length) return;

            const latest = candles[candles.length - 1];
            const first = candles[0];
            const closes = candles.map(c => parseFloat(c.close));
            const high = Math.max(...closes);
            const low = Math.min(...closes);
            const change = parseFloat(latest.close) - parseFloat(first.open);
            const changeClass = change >= 0 ? 'green' : 'red';

            document.getElementById('priceInfo').innerHTML = `
                <div class="price-stat">
                    <div class="price-label">Open</div>
                    <div class="price-value">${parseFloat(first.open).toFixed(2)}</div>
                </div>
                <div class="price-stat">
                    <div class="price-label">High</div>
                    <div class="price-value">${high.toFixed(2)}</div>
                </div>
                <div class="price-stat">
                    <div class="price-label">Low</div>
                    <div class="price-value">${low.toFixed(2)}</div>
                </div>
                <div class="price-stat">
                    <div class="price-label">Close</div>
                    <div class="price-value ${changeClass}">${parseFloat(latest.close).toFixed(2)}</div>
                </div>
            `;
        }

        function updateTopBar(candles) {
            if (!candles.length) return;

            const latest = candles[candles.length - 1];
            const first = candles[0];
            const change = parseFloat(latest.close) - parseFloat(first.open);
            const changePercent = ((change / parseFloat(first.open)) * 100).toFixed(2);
            const changeClass = change >= 0 ? '' : 'red';

            document.getElementById('topPrice').textContent = parseFloat(latest.close).toFixed(2);
            document.getElementById('topPrice').className = `symbol-price ${changeClass}`;
            document.getElementById('topChange').textContent = `${change >= 0 ? '+' : ''}${changePercent}%`;
            document.getElementById('topChange').className = `symbol-change ${changeClass}`;
        }

        async function updateMarketStats(candles) {
            if (!candles.length) return;

            // Get the most recent order book information
            let buyOrders = [];
            let sellOrders = [];
            
            try {
                const res = await fetch(`/api/orderbook?product=${encodeURIComponent(currentSymbol)}`);
                const data = await res.json();
                if (data.buy_orders) buyOrders = data.buy_orders;
                if (data.sell_orders) sellOrders = data.sell_orders;
            } catch (err) {
                console.error('Failed to load order book', err);
            }

            const latest = candles[candles.length - 1];
            const first = candles[0];
            const allCloses = candles.map(c => parseFloat(c.close));
            const high24h = Math.max(...allCloses);
            const low24h = Math.min(...allCloses);
            const totalVolume = candles.reduce((sum, c) => sum + parseInt(c.buy_volume) + parseInt(c.sell_volume), 0);
            const change = parseFloat(latest.close) - parseFloat(first.open);
            const changePercent = ((change / parseFloat(first.open)) * 100).toFixed(2);

            let buyOrdersHtml = buyOrders.length > 0 
                ? buyOrders.map(order => `
                    <div class="order-row buy">
                        <span class="order-price buy">${parseFloat(order.price).toFixed(2)}</span>
                        <span class="order-amount">${parseInt(order.amount).toLocaleString()}</span>
                    </div>
                `).join('')
                : '<div style="color: #787b86; font-size: 12px; padding: 8px;">No buy orders</div>';

            let sellOrdersHtml = sellOrders.length > 0
                ? sellOrders.map(order => `
                    <div class="order-row sell">
                        <span class="order-price sell">${parseFloat(order.price).toFixed(2)}</span>
                        <span class="order-amount">${parseInt(order.amount).toLocaleString()}</span>
                    </div>
                `).join('')
                : '<div style="color: #787b86; font-size: 12px; padding: 8px;">No sell orders</div>';

            document.getElementById('orderbookContent').innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">24h Change</div>
                    <div class="stat-value ${change >= 0 ? 'positive' : 'negative'}">
                        ${change >= 0 ? '+' : ''}${changePercent}%
                    </div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-label">24h High</div>
                    <div class="stat-value">${high24h.toFixed(2)}</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-label">24h Low</div>
                    <div class="stat-value">${low24h.toFixed(2)}</div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-label">24h Volume</div>
                    <div class="stat-value">${totalVolume.toLocaleString()}</div>
                </div>
                
                <div class="orderbook-section">
                    <div class="orderbook-section-title">Top 5 Buy Orders</div>
                    ${buyOrdersHtml}
                </div>
                
                <div class="orderbook-section">
                    <div class="orderbook-section-title">Top 5 Sell Orders</div>
                    ${sellOrdersHtml}
                </div>
            `;
        }

        // Handle sidebar tab switching
        document.querySelectorAll('.sidebar-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // Functions for running custom trading algorithms
        function runCustomAlgo() {
            const messageDiv = document.getElementById('algoMessage');
            messageDiv.innerHTML = '';
            
            if (currentChartData.length === 0) {
                messageDiv.innerHTML = '<div class="error-message">No chart data available. Please select a symbol first.</div>';
                return;
            }
            
            // Clear previous custom indicators
            customAlgoSeries.forEach(series => {
                try {
                    chart.removeSeries(series);
                } catch (e) {}
            });
            customAlgoSeries = [];
            
            const code = document.getElementById('algoEditor').value;
            
            try {
                // Create a safe function from user code
                const userFunction = new Function('data', code + '\nreturn customIndicator(data);');
                
                // Run the user's algorithm
                const result = userFunction(currentChartData);
                
                // Validate result
                if (!result) {
                    throw new Error('Algorithm must return an object');
                }
                
                // Handle multiple lines
                if (result.lines && Array.isArray(result.lines)) {
                    result.lines.forEach(line => {
                        if (!line.data || !Array.isArray(line.data)) {
                            throw new Error('Each line must have a data array');
                        }
                        
                        const series = chart.addLineSeries({
                            color: line.color || '#2962ff',
                            lineWidth: line.lineWidth || 2,
                            priceLineVisible: false,
                            lastValueVisible: false,
                        });
                        series.setData(line.data);
                        customAlgoSeries.push(series);
                    });
                } else {
                    // Handle single line
                    if (!result.data || !Array.isArray(result.data)) {
                        throw new Error('Result must have a data array');
                    }
                    
                    const series = chart.addLineSeries({
                        color: result.color || '#2962ff',
                        lineWidth: result.lineWidth || 2,
                        priceLineVisible: false,
                        lastValueVisible: false,
                    });
                    series.setData(result.data);
                    customAlgoSeries.push(series);
                }
                
                messageDiv.innerHTML = `<div class="success-message">Algorithm applied successfully! ${customAlgoSeries.length} line(s) added.</div>`;
                
            } catch (error) {
                messageDiv.innerHTML = `<div class="error-message"><strong>Error:</strong> ${error.message}</div>`;
                console.error('Algorithm error:', error);
            }
        }

        function clearCustomAlgo() {
            customAlgoSeries.forEach(series => {
                try {
                    chart.removeSeries(series);
                } catch (e) {}
            });
            customAlgoSeries = [];
            document.getElementById('algoMessage').innerHTML = '<div class="success-message">Custom indicators cleared.</div>';
            setTimeout(() => {
                document.getElementById('algoMessage').innerHTML = '';
            }, 2000);
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allSymbols.filter(s => s.toLowerCase().includes(query));
            renderSymbols(filtered);
        });

        document.querySelectorAll('.toolbar-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.toolbar-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentInterval = parseInt(btn.dataset.interval);
                loadChartData();
            });
        });

        // Handle changes to the indicator selection
        document.getElementById('indicatorSelect').addEventListener('change', (e) => {
            if (currentSymbol) {
                loadChartData();
            }
        });

        // Functions to calculate technical indicators
        function calculateSMA(data, period = 20) {
            if (data.length < period) return [];
            const result = [];
            for (let i = period - 1; i < data.length; i++) {
                const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b.value, 0);
                result.push({
                    time: data[i].time,
                    value: sum / period
                });
            }
            console.log(`Calculated ${result.length} points for Simple Moving Average`);
            return result;
        }

        function calculateEMA(data, period = 20) {
            if (data.length < period) return [];
            const result = [];
            const multiplier = 2 / (period + 1);
            let ema = data.slice(0, period).reduce((a, b) => a + b.value, 0) / period;
            
            result.push({ time: data[period - 1].time, value: ema });
            
            for (let i = period; i < data.length; i++) {
                ema = (data[i].value - ema) * multiplier + ema;
                result.push({ time: data[i].time, value: ema });
            }
            console.log(`Calculated ${result.length} points for Exponential Moving Average`);
            return result;
        }

        function calculateBollingerBands(data, period = 20, stdDev = 2) {
            if (data.length < period) return { sma: [], upper: [], lower: [] };
            
            const sma = [];
            const upper = [];
            const lower = [];
            
            for (let i = period - 1; i < data.length; i++) {
                const dataSlice = data.slice(i - period + 1, i + 1);
                const smaValue = dataSlice.reduce((sum, point) => sum + point.value, 0) / period;
                
                const variance = dataSlice.reduce((sum, point) => {
                    return sum + Math.pow(point.value - smaValue, 2);
                }, 0) / period;
                const std = Math.sqrt(variance);
                
                sma.push({
                    time: data[i].time,
                    value: smaValue
                });
                upper.push({
                    time: data[i].time,
                    value: smaValue + (std * stdDev)
                });
                lower.push({
                    time: data[i].time,
                    value: smaValue - (std * stdDev)
                });
            }
            
            console.log(`Calculated ${sma.length} points for Bollinger Bands`);
            return { sma, upper, lower };
        }

        function applyIndicator(data) {
            // Remove existing indicator series
            if (indicatorSeries) {
                chart.removeSeries(indicatorSeries);
                indicatorSeries = null;
            }
            if (upperBandSeries) {
                chart.removeSeries(upperBandSeries);
                upperBandSeries = null;
            }
            if (lowerBandSeries) {
                chart.removeSeries(lowerBandSeries);
                lowerBandSeries = null;
            }

            const indicator = document.getElementById('indicatorSelect').value;
            console.log(`Applying ${indicator} indicator to ${data.length} data points`);

            if (indicator === 'sma') {
                const smaData = calculateSMA(data, 20);
                if (smaData.length > 0) {
                    indicatorSeries = chart.addLineSeries({
                        color: '#f39c12',
                        lineWidth: 2,
                        priceLineVisible: false,
                        lastValueVisible: false,
                    });
                    indicatorSeries.setData(smaData);
                    console.log('Simple Moving Average indicator added to chart');
                }
            } else if (indicator === 'ema') {
                const emaData = calculateEMA(data, 20);
                if (emaData.length > 0) {
                    indicatorSeries = chart.addLineSeries({
                        color: '#e74c3c',
                        lineWidth: 2,
                        priceLineVisible: false,
                        lastValueVisible: false,
                    });
                    indicatorSeries.setData(emaData);
                    console.log('Exponential Moving Average indicator added to chart');
                }
            } else if (indicator === 'bb') {
                const bb = calculateBollingerBands(data, 20, 2);
                
                if (bb.sma.length > 0) {
                    indicatorSeries = chart.addLineSeries({
                        color: '#f39c12',
                        lineWidth: 1.5,
                        priceLineVisible: false,
                        lastValueVisible: false,
                    });
                    indicatorSeries.setData(bb.sma);
                    
                    upperBandSeries = chart.addLineSeries({
                        color: '#95a5a6',
                        lineWidth: 1,
                        lineStyle: 2,
                        priceLineVisible: false,
                        lastValueVisible: false,
                    });
                    upperBandSeries.setData(bb.upper);
                    
                    lowerBandSeries = chart.addLineSeries({
                        color: '#95a5a6',
                        lineWidth: 1,
                        lineStyle: 2,
                        priceLineVisible: false,
                        lastValueVisible: false,
                    });
                    lowerBandSeries.setData(bb.lower);
                    console.log('Bollinger Bands indicator added to chart');
                }
            } else {
                console.log('No technical indicator selected');
            }
        }

        initCharts();
        loadSymbols();
        refreshTimer = setInterval(loadChartData, 30000);
    </script>
</body>
</html>